# バリカン除草用マニピュレータの作り方【ソフトウェア編】

ここで紹介する機能は，  
1. バリカン制御：バリカンのスイッチを自動でON/OFFする
2. アーム制御：アームの関節角を好きな位置に移動する

の２つです．

**Ubuntu22.04で，ROS 2 Humbleを用いています.**

私の場合，任天堂の[Joy-Con](https://store-jp.nintendo.com/list/hardware-accessory/controller/HAC_A_JAVAF.html)をリモコンがわりにしています．
当然，他の物でも代替可能ですし，自然言語指示からの駆動も少しのアレンジで直ぐにできます．  
<img src="../img/joycon.png" alt="画像1" style="width: 15%;">


１のバリカン制御は，初心者でもできます．
２のアーム制御は，Moveit 2というライブラリの構造を熟知する必要があります．

また，用いる計算機のアーキテクチャによってJoy-conのパッケージが異なります．
私は，ThinkPadのラップトップ（amd64アーキテクチャ）とJetson orin nano（arm64アーキテクチャ）の２つの方法で実装しました．  
Joy-conのボタンの番号の割り当てがかなり異なることと，arm64の方ではスティックボタンが0,1の実数値しかなりません．
従って，Raspberry PiやJetsonに代表されるarm64の計算機を用いる場合，スティックボタンを割り当てるのはやめておくのが賢明でしょう．


# バリカン制御

Moveit 2でエンドエフェクタとして一括で制御する方法もありますが，私は独立させています．ON/OFF制御程度では変わらないです．
主に，3つのコードが必要です．  
1. ROS 2側：バリカンをON/OFFするタイミングを決定し，マイコン側に教える．  
2. マイコン側：受け取った信号を元に，ON/OFFする．  
ただし，ONは`Int8`型の0を，OFFは1を信号とします．あるいはbooleanだったかも？  
バリカンをON/OFFするタイミングは，今回はJoy-conボタンが押されたときとします．よって，３つ目のコードは，
3. Joy-conの特定のボタンが押されたら0/1を切り替える．  

ここまでこれば


# アーム制御  

### Moveit 2を用いる意義
私は [Moveit 2](https://moveit.picknik.ai/humble/index.html) を用いて制御しています．
実は，hand-eyeキャリブレーションによる精確なマニピュレーションタスク・障害物回避などの，複雑な制御をしていないのでわざわざ Moveit 2を用いなくてもできます．

![moveit](../img/moveit.png)

この図は，今回作るシステムの概要です．

右側のRobotのブロックは，今回の場合３つのモータを搭載したロボットアームです．  
左側のMoveit!のブロックは，Moveit!というライブラリの役割を表しており，ロボットアームの頭脳です．例えばプランニングをします．３つのモータそれぞれの関節角の目標値を決めます．  
それに挟まれたControllerのブロックは，ロボットアームとその頭脳を繋ぐものです．目標値をモータの仕様にあったコマンドに置き換えて，シリアル通信します．また，現在のモータの関節角も常時読み取ります．  

Moveit 2を用いることで，より柔軟なシステムを構築できます．

### 実装の概要

やるべきことを列挙します．

1. Moveit 2のインストール
2. Moveit 2でシミュレーションの環境構築：アームのSTLファイルを適切に配置して，`moveit_setup_assistant`を用いて制御に必要なファイル群を自動生成する．
3. Moveit 2からアームを制御：シリアル通信によって，シミュレーションとリアルの挙動を一致させる．
